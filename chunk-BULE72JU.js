import{a as i}from"./chunk-2UUWE3MU.js";import{Af as D,Bf as I,G as d,If as g,Mb as a,Nb as p,O as v,S as h,W as l,ca as o,ee as S,p as u,q as c,rc as b,z as f}from"./chunk-SYGYQDC7.js";var U=(()=>{let t=class t{constructor(){this._localServer=o(null),this._schoolUid=o(null),this._streamServer=o(null),this.localServer=this._localServer.asReadonly(),this.schoolUid=this._schoolUid.asReadonly(),this.streamServer=this._streamServer.asReadonly(),this.isOfflineMode=a(()=>i.offline&&!!this._localServer()?.length),this.envFilesUrl=a(()=>this.isOfflineMode()?this.transformUrl(i.filesUrl):i.filesUrl),i.offline&&(this._localServer.set(localStorage.getItem("_offline-local-server")),this._schoolUid.set(localStorage.getItem("_offline-school")),this._streamServer.set(localStorage.getItem("_offline-stream-server")))}transformUrl(e){if(!this.isOfflineMode())return e;let n=/^https?:\/\/([^\/]+)(\/.*)?$/,r=e.match(n);if(!r)return e;let m=r[1],N=r[2]||"";return m===this._localServer()?e:`${this._localServer()}/proxy/${m}${N}`}};t.\u0275fac=function(n){return new(n||t)},t.\u0275prov=h({token:t,factory:t.\u0275fac,providedIn:"root"});let s=t;return s})();var _=`${i.apiUrl}/app/tenants`,H=(()=>{let t=class t{constructor(){this.snackbar=l(I),this.envFilesUrl=l(U).envFilesUrl,this.tenantID=o(void 0),this.tenant_=o(void 0),this.tenant=a(()=>this.tenant_()),this.loading=o(!1),this.error=o(void 0),this.logoUrl=a(()=>this.tenant()&&`${this.envFilesUrl()}tenants/${this.tenant().id}/logo.png?v=3`),this.http=l(b),this.logger=l(D),p(()=>{this.error()&&this.snackbar.error({title:"\u05E9\u05D2\u05D9\u05D0\u05D4",msg:this.error(),btn:"\u05E1\u05D2\u05D5\u05E8",duration:1e4})}),S([this.tenantID],([e])=>{this.tenant_.set(void 0),this.loading.set(!0),e&&this.refresh().pipe(d(()=>this.loading.set(!1)),f(n=>(this.error.set(n),this.tenantID.set(void 0),c(()=>n)))).subscribe()})}determineTenant(){if(i.tenant){this.logger.debug("TenantService: DEBUG mode; use tenant from ENV:",i.tenant),this.tenantID.set(i.tenant);return}let e=localStorage.getItem("tenant");if(e&&!isNaN(+e)){this.logger.debug("TenantService: found tenant in local storage",e),this.tenantID.set(+e);return}let n=location.hostname;this.logger.debug("TenantService: locate tenant by hostname:",n),this.loading.set(!0),this.http.get(`${_}/by-host`,{context:g()}).pipe(d(()=>this.loading.set(!1)),f(r=>(this.error.set(r),c(()=>r)))).subscribe(r=>{this.logger.debug("TenantService: found tenant by hostname:",r),localStorage.setItem("tenant",r.toString()),this.tenantID.set(r)})}refresh(){return this.tenantID()?this.http.get(`${_}/${this.tenantID()}`,{context:g()}).pipe(v(e=>{this.tenant_.set(e)})):u(void 0)}addTenantToHttpRequest(e){return this.tenantID()?e.clone({setHeaders:{tenant:""+this.tenantID().toString()}}):e}};t.\u0275fac=function(n){return new(n||t)},t.\u0275prov=h({token:t,factory:t.\u0275fac,providedIn:"root"});let s=t;return s})();export{U as a,H as b};
