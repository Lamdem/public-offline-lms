import{a as r}from"./chunk-FZVJKCT4.js";import{a as l}from"./chunk-2UUWE3MU.js";import{Ac as k,Af as v,If as o,Mb as s,Nb as T,O as h,S as m,W as p,a as c,b as f,ca as g,rc as S,s as u}from"./chunk-SYGYQDC7.js";var i=`${l.apiUrl}/auth`,O=(()=>{let a=class a{profileSet(e){this.data.update(t=>f(c({},t),{user:e}))}isSelf(e){return s(()=>!!this.profile()&&this.profile().uid===e)}constructor(){this.http=p(S),this.router=p(k),this.logger=p(v),this.data=g(void 0),this.profile=s(()=>this.data()?.user),this.isLoggedin=s(()=>!!this.data()?.user),this.isContentManager=s(()=>!!((this.profile()?.auth??0)&(r.ContentManager|r.Admin|r.Super))),this.isSupport=s(()=>!!((this.profile()?.auth??0)&(r.Support|r.Admin|r.Super))),this.isAdmin=s(()=>!!((this.profile()?.auth??0)&(r.Admin|r.Super))),this.isSuper=s(()=>!!((this.profile()?.auth??0)&r.Super)),this.accessToken=s(()=>this.data()?.accessToken),this.otp=s(()=>{var{otpUid:t,debugOtp:n}=this.data()||{};return t?{otpUid:t,debugOtp:n}:void 0}),this.edu=g(void 0),this.returnUrl="",T(()=>{this.data()&&this.data().accessToken?this.startRefreshTokenTimer():this.stopRefreshTokenTimer()});let e=sessionStorage.getItem("eduData");if(e)try{let t=JSON.parse(e);t.linkingToken&&t.userFullName&&this.edu.set({linkingToken:t.linkingToken,userFullName:t.userFullName})}catch(t){console.error("Error parsing eduData from sessionStorage",t)}}login(e){return this.http.post(`${i}/login`,e,{context:o(),withCredentials:!0}).pipe(h(t=>this.data.set(t)),u(t=>t.user))}loginSSO(e){return this.http.post(`${i}/login?sso=${e}`,void 0,{context:o(),withCredentials:!0}).pipe(h(t=>this.data.set(t)),u(t=>t.user))}activateUser(e){return this.http.post(`${i}/activate`,e,{context:o(),withCredentials:!0}).pipe(h(t=>this.data.set(t)),u(t=>t.user))}refreshToken(){return this.logger.debug("[AuthService] RefreshToken"),this.http.post(`${i}/refresh-token`,null,{context:o(),withCredentials:!0}).pipe(u(e=>{if(e.error){this.logger.debugError(`[AuthService] Error: ${e.error}`);return}if(e&&e.user){let t=e.user;return this.logger.info(`[AuthService] RefreshToken. User = ${t.fname} ${t.lname}`),this.data.set(e),t}}))}logout(){this.logger.info("[AuthService] logout"),this.http.post(`${i}/logout`,void 0,{withCredentials:!0}).subscribe(()=>{this.handleLogout()})}handleLogout(){this.data.set(void 0),this.router.navigate([l.notAuthorizedPath])}startRefreshTokenTimer(){let e=this.accessToken().split(".")[1],t=JSON.parse(atob(e)),b=new Date(t.exp*1e3).getTime()-Date.now()-60*1e3;this.refreshTokenTimer=setTimeout(()=>this.refreshToken().subscribe(),b)}stopRefreshTokenTimer(){clearTimeout(this.refreshTokenTimer)}otpSend(e){return this.http.post(`${i}/otp/send`,JSON.stringify(e))}otpCheck(e,t){return this.http.post(`${i}/otp/check/${e}`,t)}otpLoginCheck(e,t){return this.http.post(`${i}/otp/login-check/${e}`,t,{context:o(),withCredentials:!0}).pipe(h(n=>{this.data.set(n)}))}resetPwd(e,t){return this.http.post(`${i}/reset-pwd/${e}`,JSON.stringify(t),{context:o(),withCredentials:!0}).pipe(h(n=>{this.data.set(n)}))}googleSSO(e){return this.http.post(`${i}/signin-google`,{idToken:e},{context:o(),withCredentials:!0})}eduSetSessionState(e=void 0){e?sessionStorage.setItem("edu_data",JSON.stringify(e)):sessionStorage.removeItem("edu_data")}parseEduResponse(e,t){return this.http.post(`${i}/signin-oidc`,{code:e,state:t},{context:o(),withCredentials:!0}).pipe(h(n=>{this.data.set(n)}))}setAuthData(e){this.data.set(e)}};a.\u0275fac=function(t){return new(t||a)},a.\u0275prov=m({token:a,factory:a.\u0275fac,providedIn:"root"});let d=a;return d})();export{O as a};
